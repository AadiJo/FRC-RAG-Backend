<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRC RAG</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Syntax highlighting for code blocks -->
    <link href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css" rel="stylesheet">
    <!-- Markdown renderer and sanitizer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.9/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
</head>
<body>
    <div class="chat-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="logo-placeholder">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="logo-text">FRC RAG</div>
                </div>
                <button class="new-chat-btn">
                    <i class="fas fa-plus"></i>
                    New Chat
                </button>
            </div>
            <div class="sidebar-content">
                <div class="chat-history">
                    <!-- Chat history will go here -->
                </div>
            </div>
            <div class="sidebar-footer">
                <div class="user-menu">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <span>User</span>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-chat">
            <!-- Header -->
            <div class="chat-header">
                <div class="header-content">
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="header-title">
                        <h1>FRC RAG Chat Assistant</h1>
                    </div>
                </div>
            </div>

            <!-- Chat Messages Area -->
            <div class="chat-messages" id="chatMessages">
                <div class="message assistant-message welcome-message">
                    <div class="message-content">
                        <div class="message-avatar">
                            <div class="assistant-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                        </div>
                        <div class="message-text-container">
                            <div class="message-text">
                                <h3>Welcome to FRC RAG Chat Assistant! ðŸ¤–</h3>
                                <p>I can help you with First Robotics Competition questions using data from team technical binders. Here's what I can do:</p>
                                <ul>
                                    <li><strong>Answer technical questions</strong> about FRC robots, mechanisms, and strategies</li>
                                    <li><strong>Find relevant images</strong> from team documentation</li>
                                    <li><strong>Explain game pieces and mechanisms</strong> with enhanced context</li>
                                    <li><strong>Provide detailed analysis</strong> based on team technical documentation</li>
                                </ul>
                                <p>Try asking me something like:</p>
                                <ul>
                                    <li>"How do teams handle ground intake?"</li>
                                    <li>"Show me swerve drive implementations"</li>
                                    <li>"What are common scoring mechanisms?"</li>
                                </ul>
                                <p><strong>Just type your question below to get started!</strong></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <div class="input-area">
                        <textarea id="messageInput" placeholder="Ask me anything about FRC..."></textarea>
                        <button id="sendButton">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner">
                <i class="fas fa-cog fa-spin"></i>
                <p>Processing your query...</p>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="image-modal" id="imageModal">
        <div class="image-modal-content">
            <span class="image-modal-close" id="modalClose">&times;</span>
            <img class="image-modal-img" id="modalImage" src="" alt="">
            <div class="image-modal-info" id="modalInfo">
                <h3 id="modalTitle"></h3>
                <p id="modalDescription"></p>
            </div>
        </div>
    </div>

    <script>
        // Function declarations first (hoisted)
        function addMessage(text, sender, images = [], isError = false, enhancedData = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message${isError ? ' error-message' : ''}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            if (sender === 'user') {
                avatarDiv.innerHTML = '<div class="user-avatar"><i class="fas fa-user"></i></div>';
            } else {
                avatarDiv.innerHTML = '<div class="assistant-avatar"><i class="fas fa-robot"></i></div>';
            }

            const textContentDiv = document.createElement('div');
            textContentDiv.className = 'message-text-container';

            // Add game piece mapping info if available
            if (enhancedData && enhancedData.matched_pieces) {
                // Handle matched_pieces as either string or array
                let matchedPiecesText = '';
                if (Array.isArray(enhancedData.matched_pieces)) {
                    matchedPiecesText = enhancedData.matched_pieces.join(', ');
                } else {
                    matchedPiecesText = enhancedData.matched_pieces.toString();
                }
                
                if (matchedPiecesText.trim()) {
                    const mappingDiv = document.createElement('div');
                    mappingDiv.className = 'game-piece-mapping';
                    mappingDiv.innerHTML = `
                        <div class="mapping-header">
                            <i class="fas fa-link"></i> Game Piece Mapping
                        </div>
                        <div class="mapping-content">
                            Detected: <strong>${matchedPiecesText}</strong>
                            ${enhancedData.enhanced_query !== enhancedData.query ? 
                                `<br><small>Enhanced search: "${enhancedData.enhanced_query}"</small>` : ''}
                        </div>
                    `;
                    textContentDiv.appendChild(mappingDiv);
                }
            }

            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.innerHTML = formatText(text);

            textContentDiv.appendChild(textDiv);

            // Syntax highlight any code blocks
            try {
                textDiv.querySelectorAll('pre code').forEach((block) => {
                    if (window.hljs) window.hljs.highlightElement(block);
                });
            } catch (e) { /* no-op */ }

            // Add images if present
            if (images && images.length > 0) {
                const imagesDiv = document.createElement('div');
                imagesDiv.className = 'message-images';
                
                const imageHeader = document.createElement('div');
                imageHeader.className = 'image-header';
                imageHeader.innerHTML = `<i class="fas fa-images"></i> Related Images (${images.length})`;
                imagesDiv.appendChild(imageHeader);

                const imageGrid = document.createElement('div');
                imageGrid.className = 'image-grid';

                images.forEach((image, index) => {
                    const imageItem = createImageItem(image, index);
                    imageGrid.appendChild(imageItem);
                });

                imagesDiv.appendChild(imageGrid);
                textContentDiv.appendChild(imagesDiv);
            }

            contentDiv.appendChild(avatarDiv);
            contentDiv.appendChild(textContentDiv);

            messageDiv.appendChild(contentDiv);

            const chatMessages = document.getElementById('chatMessages');
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function createImageItem(image, index) {
            const imageDiv = document.createElement('div');
            imageDiv.className = 'image-item';

            if (image.exists) {
                // Create image container for better hover behavior
                const imgContainer = document.createElement('div');
                imgContainer.className = 'image-thumbnail-container';
                
                const img = document.createElement('img');
                img.src = `/images/${image.web_path}`;
                img.alt = image.filename;
                img.className = 'image-thumbnail';
                
                const overlay = document.createElement('div');
                overlay.className = 'image-overlay';
                overlay.innerHTML = `
                    <i class="fas fa-search-plus"></i>
                    <span>Click to view</span>
                `;
                
                // Add click event to container for better handling
                const clickHandler = () => openImageModal(image);
                imgContainer.addEventListener('click', clickHandler);
                
                imgContainer.appendChild(img);
                imgContainer.appendChild(overlay);
                imageDiv.appendChild(imgContainer);
            } else {
                imageDiv.className += ' image-not-found';
                imageDiv.innerHTML = `
                    <div class="image-placeholder">
                        <i class="fas fa-image"></i>
                        <span>Image not found</span>
                    </div>
                `;
            }

            const infoDiv = document.createElement('div');
            infoDiv.className = 'image-info';
            
            // Create the basic info section
            const basicInfo = document.createElement('div');
            basicInfo.className = 'image-basic-info';
            basicInfo.innerHTML = `
                <div class="image-filename">${getTeamDisplayName(image.web_path || image.file_path)}</div>
                <div class="image-page">Page ${image.page || 'N/A'}</div>
            `;
            infoDiv.appendChild(basicInfo);
            
            // Add context summary if available with improved formatting
            if (image.context_summary && image.context_summary.trim()) {
                const contextDiv = document.createElement('div');
                contextDiv.className = 'image-context-summary';
                
                // Truncate long context for better display
                let contextText = image.context_summary.trim();
                if (contextText.length > 120) {
                    contextText = contextText.substring(0, 120) + '...';
                }
                
                contextDiv.innerHTML = `
                    <div class="context-label"><i class="fas fa-info-circle"></i> Context</div>
                    <div class="context-text">${contextText}</div>
                `;
                infoDiv.appendChild(contextDiv);
            }
            
            // Make info div clickable but prevent event bubbling issues
            infoDiv.addEventListener('click', (e) => {
                e.stopPropagation();
                if (image.exists) {
                    openImageModal(image);
                }
            });

            imageDiv.appendChild(infoDiv);
            return imageDiv;
        }

        function openImageModal(image) {
            const imageModal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalTitle = document.getElementById('modalTitle');
            const modalDescription = document.getElementById('modalDescription');
            
            console.log('Opening modal for image:', image.filename);
            modalImage.src = `/images/${image.web_path}`;
            modalTitle.textContent = getTeamDisplayName(image.web_path || image.file_path);
            
            let modalContent = `
                <strong>Page:</strong> ${image.page || 'N/A'}<br>
                <strong>Path:</strong> ${image.file_path}<br>
            `;
            
            // Show formatted context if available, otherwise fall back to OCR text
            if (image.formatted_context && image.formatted_context.trim()) {
                modalContent += `<div class="formatted-context"><strong>Context:</strong><br><pre class="context-content">${image.formatted_context}</pre></div>`;
            } else if (image.ocr_text && image.ocr_text.trim()) {
                modalContent += `<div class="formatted-context"><strong>OCR Text:</strong><br><pre class="context-content">${image.ocr_text}</pre></div>`;
            }
            
            modalDescription.innerHTML = modalContent;
            imageModal.style.display = 'block';
            console.log('Modal should now be visible');
        }

        function closeModal() {
            const imageModal = document.getElementById('imageModal');
            imageModal.style.display = 'none';
        }

        function formatText(text) {
            // Render Markdown (GFM) and sanitize the HTML output
            try {
                marked.setOptions({ gfm: true, breaks: true, headerIds: false, mangle: false });
                const html = marked.parse(text || '');
                return DOMPurify.sanitize(html);
            } catch (err) {
                const escaped = (text || '')
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/\n/g, '<br>');
                return escaped;
            }
        }

        function showLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'none';
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function getTeamDisplayName(imagePath) {
            // Extract team number from the file path
            // Path format: "1323-2025/page0_img1.png" or "data/images/1323-2025/page0_img1.png"
            const pathParts = imagePath.split('/');
            
            // Find the folder that contains team number (format: XXXX-YYYY)
            for (let part of pathParts) {
                // Match pattern like "1323-2025" (team number followed by year)
                const match = part.match(/^(\d+)-(\d{4})$/);
                if (match) {
                    const teamNumber = match[1];
                    return `FRC ${teamNumber}`;
                }
            }
            
            // Fallback to original filename if no team pattern found
            return imagePath.split('/').pop();
        }

        // DOM Elements
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const modalTitle = document.getElementById('modalTitle');
        const modalDescription = document.getElementById('modalDescription');
        const modalClose = document.getElementById('modalClose');
        const sidebarToggle = document.getElementById('sidebarToggle');

        // Sidebar toggle functionality
        sidebarToggle.addEventListener('click', function() {
            document.querySelector('.sidebar').classList.toggle('collapsed');
        });

        // Event Listeners
        console.log('Setting up event listeners...');
        console.log('sendButton:', sendButton);
        console.log('messageInput:', messageInput);
        
        sendButton.addEventListener('click', function() {
            console.log('Send button clicked!');
            sendMessage();
        });
        
        messageInput.addEventListener('keypress', function(e) {
            console.log('Key pressed:', e.key);
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        modalClose.addEventListener('click', closeModal);
        imageModal.addEventListener('click', function(e) {
            if (e.target === imageModal) {
                closeModal();
            }
        });

        // Functions
        function sendMessage() {
            console.log('sendMessage function called');
            const message = messageInput.value.trim();
            console.log('Message:', message);
            if (!message) {
                console.log('No message, returning');
                return;
            }

            console.log('Adding user message to chat');
            // Add user message to chat
            addMessage(message, 'user');
            
            // Clear input
            messageInput.value = '';
            
            // Show loading
            showLoading();
            
            console.log('Sending request to backend...');
            // Send request to backend
            fetch('/api/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: message })
            })
            .then(response => {
                console.log('Response received:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Data received:', data);
                hideLoading();
                if (data.error) {
                    addMessage(`Error: ${data.error}`, 'assistant', [], true);
                } else {
                    addMessage(data.response, 'assistant', data.images, false, data);
                }
            })
            .catch(error => {
                console.error('Detailed error:', error);
                hideLoading();
                addMessage(`Error: ${error.message || error}. Check browser console for details.`, 'assistant', [], true);
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, focusing input');
            messageInput.focus();
            console.log('Page fully loaded and ready!');
        });
    </script>
</body>
</html>